<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="web/style.css" />
    <link rel="icon" href="web/robocontrol.ico" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Servo Control</title>

    <script>
      let ws;

      function initWS() {
        ws = new WebSocket("ws://" + window.location.host + "/ws");

        ws.onopen = () => {
          console.log("WS connected");
          document.querySelector(".status-dot").style.background = "limegreen";
          document.querySelector(".status span").textContent = "Connected";
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);

          // Realtime sensor updates
          if (data.sensors) {
            const container = document.getElementById("sensor-values");
            container.innerHTML = "";
            data.sensors.forEach((sensor) => {
              const div = document.createElement("div");
              div.className = "sensor-value";
              div.innerHTML = `<strong>Sensor ${sensor.id}:</strong> Angle: ${sensor.angle.toFixed(1)}°`;
              container.appendChild(div);
            });
          }

          if (data.status) {
            console.log("WS status:", data.status);
          }
        };

        ws.onclose = () => {
          console.log("WS disconnected, retrying...");
          document.querySelector(".status-dot").style.background = "red";
          document.querySelector(".status span").textContent = "Disconnected";
          setTimeout(initWS, 2000);
        };
      }

      // Set servo angle
      function setServo(servoId) {
        const angle = document.getElementById(`servo-${servoId}`).value;
        ws.send(JSON.stringify({ servo: servoId, angle: parseInt(angle) }));
        document.getElementById(`servo-value-${servoId}`).textContent = angle + "°";
      }

      // Move to XYZ
      function moveXYZ() {
        const x = parseFloat(document.getElementById("x").value);
        const y = parseFloat(document.getElementById("y").value);
        const z = parseFloat(document.getElementById("z").value);
        if (isNaN(x) || isNaN(y) || isNaN(z)) {
          alert("Please enter valid numbers");
          return;
        }
        ws.send(JSON.stringify({ cmd: "move_xyz", x: x, y: y, z: z }));
      }

      // File upload
      async function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a file first.");
          return;
        }
        if (!/\.(txt|gcode)$/i.test(file.name)) {
          alert("Only .txt or .gcode are allowed.");
          return;
        }

        const res = await fetch("/file/" + encodeURIComponent(file.name), {
          method: "PUT",
          headers: { "Content-Type": "text/plain" },
          body: await file.text(),
        });
        if (!res.ok) {
          alert("Error uploading file");
          return;
        }
        fileInput.value = "";
        loadFiles();
      }

      // Load file list
      async function loadFiles() {
        const list = document.getElementById("files-body");
        if (!list) return;
        list.innerHTML = `<tr><td colspan="4" style="padding:8px;">Loading…</td></tr>`;

        try {
          const res = await fetch("/files");
          if (!res.ok) throw new Error("HTTP " + res.status);
          const files = await res.json();

          if (!files.length) {
            list.innerHTML = `<tr><td colspan="4" style="padding:8px;">No files found</td></tr>`;
            return;
          }

          list.innerHTML = "";
          for (const f of files) {
            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td style="border-bottom:1px solid #eee; padding:6px 8px;">
                <input class="file-chk" type="checkbox" value="${f.name}">
              </td>
              <td style="border-bottom:1px solid #eee; padding:6px 8px;">
                <a href="/file/${encodeURIComponent(f.name)}" target="_blank">${f.name}</a>
              </td>
              <td style="border-bottom:1px solid #eee; padding:6px 8px; text-align:right;">${f.size}</td>
              <td style="border-bottom:1px solid #eee; padding:6px 8px;">
                <button data-del="${f.name}">Delete</button>
              </td>
            `;
            list.appendChild(tr);
          }

          // Actions
          document.querySelectorAll("button[data-del]").forEach((btn) => {
            btn.onclick = async () => {
              const name = btn.getAttribute("data-del");
              if (!confirm(`Delete "${name}"?`)) return;
              const r = await fetch("/file/" + encodeURIComponent(name), { method: "DELETE" });
              if (!r.ok) {
                alert("Delete failed");
                return;
              }
              loadFiles();
            };
          });
        } catch (e) {
          list.innerHTML = `<tr><td colspan="4" style="padding:8px;">Error: ${e}</td></tr>`;
        }
      }

      // Delete selected files
      async function deleteSelected() {
        const checks = Array.from(document.querySelectorAll(".file-chk:checked"));
        if (!checks.length) {
          alert("Nothing selected.");
          return;
        }
        if (!confirm(`Delete ${checks.length} file(s)?`)) return;

        for (const c of checks) {
          await fetch("/file/" + encodeURIComponent(c.value), { method: "DELETE" });
        }
        loadFiles();
      }

      // Single onload hook (WS + files)
      window.onload = function () {
        initWS();
        loadFiles();
      };
    </script>
  </head>

  <body>
    <!-- Navbar -->
    <div class="navbar">
      <h2><a href="/" style="text-decoration: none; color: white">RoboControl</a></h2>
      <div class="status">
        <div class="status-dot"></div>
        <span>Disconnected</span>
      </div>
    </div>

    <!-- Move to XYZ -->
    <div class="main-container">
      <div class="container">
        <h1>Move to XYZ</h1>
        <div class="form-group">
          <label for="x">X [mm]:</label>
          <input type="number" id="x" step="1" value="100" />
        </div>
        <div class="form-group">
          <label for="y">Y [mm]:</label>
          <input type="number" id="y" step="1" value="50" />
        </div>
        <div class="form-group">
          <label for="z">Z [mm]:</label>
          <input type="number" id="z" step="1" value="100" />
        </div>
        <button onclick="moveXYZ()">Move</button>
      </div>

      <!-- Servo Control -->
      <div class="column">
        <div class="container">
          <h1>Servo Control - joint space</h1>
          <div id="servo-controls">
            <!-- Servo sliders -->
            <div class="servo-control">
              <label>Servo GPIO_NUM_35:</label>
              <input
                type="range"
                min="0"
                max="180"
                value="90"
                id="servo-0"
                oninput="document.getElementById('servo-value-0').textContent = this.value + '°'"
              />
              <span id="servo-value-0">90°</span>
              <button onclick="setServo(0)">Set</button>
            </div>

            <div class="servo-control">
              <label>Servo GPIO_NUM_36:</label>
              <input
                type="range"
                min="0"
                max="180"
                value="90"
                id="servo-1"
                oninput="document.getElementById('servo-value-1').textContent = this.value + '°'"
              />
              <span id="servo-value-1">90°</span>
              <button onclick="setServo(1)">Set</button>
            </div>

            <div class="servo-control">
              <label>Servo GPIO_NUM_37:</label>
              <input
                type="range"
                min="0"
                max="180"
                value="90"
                id="servo-2"
                oninput="document.getElementById('servo-value-2').textContent = this.value + '°'"
              />
              <span id="servo-value-2">90°</span>
              <button onclick="setServo(2)">Set</button>
            </div>

            <div class="servo-control">
              <label>Servo GPIO_NUM_39:</label>
              <input
                type="range"
                min="0"
                max="180"
                value="90"
                id="servo-3"
                oninput="document.getElementById('servo-value-3').textContent = this.value + '°'"
              />
              <span id="servo-value-3">90°</span>
              <button onclick="setServo(3)">Set</button>
            </div>

            <div class="servo-control">
              <label>Servo GPIO_NUM_40:</label>
              <input
                type="range"
                min="0"
                max="180"
                value="90"
                id="servo-4"
                oninput="document.getElementById('servo-value-4').textContent = this.value + '°'"
              />
              <span id="servo-value-4">90°</span>
              <button onclick="setServo(4)">Set</button>
            </div>

            <div class="servo-control">
              <label>Servo GPIO_NUM_41:</label>
              <input
                type="range"
                min="0"
                max="180"
                value="90"
                id="servo-5"
                oninput="document.getElementById('servo-value-5').textContent = this.value + '°'"
              />
              <span id="servo-value-5">90°</span>
              <button onclick="setServo(5)">Set</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensors -->
      <div class="column">
        <div class="container">
          <h2>Sensor Values</h2>
          <div id="sensor-values" class="sensor-container">
            <p>Waiting for data...</p>
          </div>
        </div>

        <!-- ===== Upload + Files ===== -->
        <div class="container">
          <h2>Files (.txt, .gcode)</h2>

          <!-- Upload controls -->
          <div class="upload-container" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap">
            <input type="file" id="fileInput" accept=".txt,.gcode" />
            <button onclick="uploadFile()">Upload</button>
          </div>

          <!-- Files table -->
          <div style="overflow: auto; margin-top: 10px">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 40px">☐</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px">Name</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 120px">Size [B]</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 120px">Actions</th>
                </tr>
              </thead>
              <tbody id="files-body">
                <tr>
                  <td colspan="4" style="padding: 8px">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
          <button onclick="deleteSelected()">Delete selected</button>
        </div>

        <!-- WiFi Configuration -->
        <div class="container">
          <h2>WiFi Configuration</h2>
          <button onclick="window.location.href='/settings'">WiFi Configuration</button>
        </div>

        <!-- Footer -->
        <div class="footer">
          <p>RoboControl Petr Oblouk © 2025</p>
        </div>
      </div>
    </div>
  </body>
</html>
