<!-- @format -->

<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="web/style.css" />
    <link rel="icon" href="web/robocontrol.ico" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Servo Control</title>

    <script>
      let ws;
      document.addEventListener("DOMContentLoaded", () => {
        const gauges = document.querySelectorAll(".gauge");
        gauges.forEach((g) => createGauge(g, g.dataset.id));
      });

      function initWS() {
        ws = new WebSocket("ws://" + window.location.host + "/ws");

        ws.onopen = () => {
          console.log("WS connected");
          document.getElementById("wifi-dot").style.background = "#22c55e"; // Green
          document.getElementById("wifi-state").textContent = "Connected";

          ws.send(JSON.stringify({ cmd: "sensors" }));
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.state) {
            const elText = document.getElementById("robot-state");
            const elDot = document.getElementById("robot-dot");

            elText.textContent = data.state;

            if (data.state === "IDLE") {
              elDot.style.background = "#fbbf24"; // Orange
            } else if (data.state === "RUNNING") {
              elDot.style.background = "#22c55e"; // Green
            } else if (data.state === "ALARM" || data.state === "ERROR") {
              elDot.style.background = "#ef4444"; // Red
            } else {
              elDot.style.background = "gray";
            }
          }

          if (data.sensors) {
            const container = document.getElementById("sensor-values");

            if (container) {
              container.innerHTML = "";
            }

            data.sensors.forEach((s) => {
              const g = document.querySelector(`.gauge[data-id="${s.id}"]`);
              if (g) updateGauge(g, s.angle);

              if (container) {
                const div = document.createElement("div");
                div.className = "sensor-value";
                div.innerHTML = `<strong>Sensor ${s.id}:</strong> Angle: ${s.angle.toFixed(1)}°`;
                container.appendChild(div);
              }
            });
          }

          if (data.status) {
            console.log("WS status:", data.status);
          }
        };

        ws.onclose = () => {
          console.log("WS disconnected, retrying...");

          document.getElementById("wifi-dot").style.background = "#ef4444";
          document.getElementById("wifi-state").textContent = "Disconnected";

          document.getElementById("robot-dot").style.background = "#888";
          document.getElementById("robot-state").textContent = "Offline";

          setTimeout(initWS, 2000);
        };
      }

      // Gauge
      const GAUGE_MIN = 0;
      const GAUGE_MAX = 180;
      const TOLERANCE = 5;

      function gaugeColor(angle) {
        if (angle <= GAUGE_MIN + TOLERANCE || angle >= GAUGE_MAX - TOLERANCE) return "#ef4444";
        if (angle < 20 || angle > 160) return "#f59e0b";
        return "#22c55e";
      }

      function createGauge(el, id) {
        el.innerHTML = `
          <svg viewBox="0 0 100 50">
            <path d="M10 50 A40 40 0 0 1 90 50"
                  fill="none"
                  stroke="#334155"
                  stroke-width="8"/>
            <path class="gauge-fill"
                  d="M10 50 A40 40 0 0 1 90 50"
                  fill="none"
                  stroke="#22c55e"
                  stroke-width="8"
                  stroke-dasharray="126"
                  stroke-dashoffset="126"/>
          </svg>
          <div class="gauge-value">--°</div>
          <div class="gauge-label">Servo ${id}</div>
        `;
      }

      function updateGauge(el, angle) {
        const fill = el.querySelector(".gauge-fill");
        const value = el.querySelector(".gauge-value");

        const clamped = Math.max(GAUGE_MIN, Math.min(GAUGE_MAX, angle));
        const percent = clamped / GAUGE_MAX;
        const dash = 126 * (1 - percent);

        fill.style.strokeDashoffset = dash;
        fill.style.stroke = gaugeColor(clamped);
        value.textContent = clamped.toFixed(1) + "°";
      }

      // Set servo angle
      function setServo(servoId) {
        const angle = document.getElementById(`servo-${servoId}`).value;
        ws.send(JSON.stringify({ servo: servoId, angle: parseInt(angle) }));
        document.getElementById(`servo-value-${servoId}`).textContent = angle + "°";
      }

      // Move to XYZ
      function moveXYZ() {
        const x = parseFloat(document.getElementById("x").value);
        const y = parseFloat(document.getElementById("y").value);
        const z = parseFloat(document.getElementById("z").value);
        if (isNaN(x) || isNaN(y) || isNaN(z)) {
          alert("Please enter valid numbers");
          return;
        }
        ws.send(JSON.stringify({ cmd: "move_xyz", x: x, y: y, z: z }));
      }

      // Send manual G-code line
      function sendGcodeLine() {
        const input = document.getElementById("gcode_input");
        const line = input.value.trim();

        if (!line) {
          alert("Please enter a command");
          return;
        }

        ws.send(JSON.stringify({ cmd: "gcode_line", line: line }));
        input.value = "";
      }

      // File upload
      async function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a file first.");
          return;
        }
        if (!/\.(txt|gcode)$/i.test(file.name)) {
          alert("Only .txt or .gcode are allowed.");
          return;
        }

        const res = await fetch("/file/" + encodeURIComponent(file.name), {
          method: "PUT",
          headers: { "Content-Type": "text/plain" },
          body: await file.text(),
        });
        if (!res.ok) {
          alert("Error uploading file");
          return;
        }
        fileInput.value = "";
        loadFiles();
      }

      // Load file list
      function runFile(filename) {
        if (!confirm(`Run program "${filename}"?`)) return;
        ws.send(JSON.stringify({ cmd: "run_gcode", filename: filename }));
        alert("Send.");
      }

      function stopRobot() {
        ws.send(JSON.stringify({ cmd: "gcode_stop" }));

        document.getElementById("robot-state").textContent = "STOPPED";
        document.getElementById("robot-dot").style.background = "#ef4444";
      }

      async function loadFiles() {
        const list = document.getElementById("files-body");
        if (!list) return;
        list.innerHTML = `<tr><td colspan="5" style="padding:8px;">Loading…</td></tr>`;

        try {
          const res = await fetch("/files");
          if (!res.ok) throw new Error("HTTP " + res.status);
          const files = await res.json();

          if (!files.length) {
            list.innerHTML = `<tr><td colspan="5" style="padding:8px;">No files found</td></tr>`;
            return;
          }

          list.innerHTML = "";
          for (const f of files) {
            const tr = document.createElement("tr");

            tr.innerHTML = `
        <td style="border-bottom:1px solid #eee; padding:6px 8px;">
          <input class="file-chk" type="checkbox" value="${f.name}">
        </td>
        <td style="border-bottom:1px solid #eee; padding:6px 8px;">
          <a href="/file/${encodeURIComponent(f.name)}" target="_blank">${f.name}</a>
        </td>
        <td style="border-bottom:1px solid #eee; padding:6px 8px; text-align:right;">${f.size} B</td>
        <td style="border-bottom:1px solid #eee; padding:6px 8px; text-align:center;">
           <button style="background: #22c55e; width: auto; padding: 5px 10px;" onclick="runFile('${f.name}')">▶ Run</button>
        </td>
        <td style="border-bottom:1px solid #eee; padding:6px 8px;">
          <button style="background: #ef4444; width: auto; padding: 5px 10px;" data-del="${f.name}">Delete</button>
        </td>
      `;
            list.appendChild(tr);
          }

          document.querySelectorAll("button[data-del]").forEach((btn) => {
            btn.onclick = async () => {
              const name = btn.getAttribute("data-del");
              if (!confirm(`Delete "${name}"?`)) return;
              const r = await fetch("/file/" + encodeURIComponent(name), { method: "DELETE" });
              if (!r.ok) {
                alert("Delete failed");
                return;
              }
              loadFiles();
            };
          });
        } catch (e) {
          list.innerHTML = `<tr><td colspan="5" style="padding:8px;">Error: ${e}</td></tr>`;
        }
      }

      // Delete selected files
      async function deleteSelected() {
        const checks = Array.from(document.querySelectorAll(".file-chk:checked"));
        if (!checks.length) {
          alert("Nothing selected.");
          return;
        }
        if (!confirm(`Delete ${checks.length} file(s)?`)) return;

        for (const c of checks) {
          await fetch("/file/" + encodeURIComponent(c.value), { method: "DELETE" });
        }
        loadFiles();
      }

      // Single onload hook (WS + files)
      window.onload = function () {
        initWS();
        loadFiles();
      };
    </script>
  </head>

  <body>
    <div class="navbar">
      <h2><a href="/" style="text-decoration: none; color: white">RoboControl</a></h2>

      <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center">
        <button
          onclick="stopRobot()"
          style="
            background: #dc2626;
            color: white;
            font-weight: bold;
            padding: 5px 15px;
            border: 2px solid #b91c1c;
            width: auto;
            margin: 0;
            cursor: pointer;
          "
        >
          STOP
        </button>

        <div class="status">
          <span style="opacity: 0.7; font-size: 0.8em; margin-right: 5px">ROBOT:</span>
          <div class="status-dot" id="robot-dot" style="background: #888"></div>
          <span id="robot-state">Unknown</span>
        </div>

        <div class="status">
          <span style="opacity: 0.7; font-size: 0.8em; margin-right: 5px">WIFI:</span>
          <div class="status-dot" id="wifi-dot" style="background: #ef4444"></div>
          <span id="wifi-state">Disconnected</span>
        </div>
      </div>
    </div>

<div class="main-container">
      <div class="container">
        <h1>Move to XYZ</h1>

        <div class="container">
          <div class="form-group">
            <label for="x">X [mm]:</label>
            <input type="number" id="x" step="1" value="100" />
          </div>
          <div class="form-group">
            <label for="y">Y [mm]:</label>
            <input type="number" id="y" step="1" value="50" />
          </div>
          <div class="form-group">
            <label for="z">Z [mm]:</label>
            <input type="number" id="z" step="1" value="100" />
          </div>
          <button onclick="moveXYZ()">Move</button>
        </div>

        <div class="container">
          <h2>Manual G-Code</h2>
          <div class="form-group" style="display: flex; gap: 10px">
            <input
              type="text"
              id="gcode_input"
              placeholder="e.g. G1 X100 Y50"
              onkeydown="if (event.key === 'Enter') sendGcodeLine();"
            />
            <button style="width: auto" onclick="sendGcodeLine()">Send</button>
          </div>
        </div>
        
      </div>
    </div>

  <div class="column">
    <div class="container">
      <h1>Servo Control - joint space (with limits)</h1>

      <div id="servo-controls">

        <div class="servo-control" id="servo-control-0">
          <label>J0 (GPIO_NUM_35):</label>
          <input
            type="range"
            value="90"
            id="servo-0"
            oninput="setServoUI(0)"
          />
          <span id="servo-value-0">90°</span>
          <button onclick="setServo(0)">Set</button>
        </div>

        <!-- J1: master (GPIO36) + follower (GPIO37) -->
        <div class="servo-control" id="servo-control-1">
          <label>J1 (GPIO_NUM_36 + GPIO_NUM_37):</label>
          <input
            type="range"
            value="90"
            id="servo-1"
            oninput="setServoUI(1)"
          />
          <span id="servo-value-1">90°</span>
          <button onclick="setServoGrouped(1)">Set</button>
        </div>

        <!-- follower UI (GPIO37) -->
        <div class="servo-control" id="servo-control-2">
          <label>Follower (GPIO_NUM_37):</label>
          <input
            type="range"
            value="90"
            id="servo-2"
            oninput="setServoUI(1)"
            disabled
          />
          <span id="servo-value-2">90°</span>
          <button disabled>Set</button>
        </div>

        <div class="servo-control" id="servo-control-3">
          <label>J2 (GPIO_NUM_39):</label>
          <input
            type="range"
            value="90"
            id="servo-3"
            oninput="setServoUI(3)"
          />
          <span id="servo-value-3">90°</span>
          <button onclick="setServo(3)">Set</button>
        </div>

        <div class="servo-control" id="servo-control-4">
          <label>J3 (GPIO_NUM_40):</label>
          <input
            type="range"
            value="90"
            id="servo-4"
            oninput="setServoUI(4)"
          />
          <span id="servo-value-4">90°</span>
          <button onclick="setServo(4)">Set</button>
        </div>

        <div class="servo-control" id="servo-control-5">
          <label>J4 (GPIO_NUM_41):</label>
          <input
            type="range"
            value="90"
            id="servo-5"
            oninput="setServoUI(5)"
          />
          <span id="servo-value-5">90°</span>
          <button onclick="setServo(5)">Set</button>
        </div>

        <!-- pokud máš servo 6 (GPIO42) -->
        <div class="servo-control" id="servo-control-6">
          <label>J5 (GPIO_NUM_42) Gripper:</label>
          <input
            type="range"
            value="90"
            id="servo-6"
            oninput="setServoUI(6)"
          />
          <span id="servo-value-6">90°</span>
          <button onclick="setServo(6)">Set</button>
        </div>

      </div>
    </div>
  </div>


      <div class="column">
        <div class="container">
          <h2>Joint Angles</h2>
          <div class="gauges">
            <div class="gauge" data-id="0"></div>
            <div class="gauge" data-id="1"></div>
            <div class="gauge" data-id="2"></div>
            <div class="gauge" data-id="3"></div>
            <div class="gauge" data-id="4"></div>
            <div class="gauge" data-id="5"></div>
          </div>
        </div>

        <div class="container">
          <h2>Files (.txt, .gcode)</h2>

          <div class="upload-container" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap">
            <input type="file" id="fileInput" accept=".txt,.gcode" />
            <button onclick="uploadFile()">Upload</button>
          </div>

          <div style="overflow: auto; margin-top: 10px">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 40px">☐</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px">Name</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 100px">Size</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 80px">Run</th>
                  <th style="border-bottom: 1px solid #fff; padding: 6px 8px; width: 80px">Delete</th>
                </tr>
              </thead>
              <tbody id="files-body">
                <tr>
                  <td colspan="4" style="padding: 8px">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
          <button onclick="deleteSelected()">Delete selected</button>
        </div>

        <div class="container">
          <h2>WiFi Configuration</h2>
          <button onclick="window.location.href = '/settings'">WiFi Configuration</button>
        </div>

        <div class="footer">
          <p>RoboControl Petr Oblouk © 2025</p>
        </div>
      </div>
    </div>
  </body>
</html>
